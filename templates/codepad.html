{% extends "base.html" %}
{% block content %}
<h2>{{ page.title }} · <em>Code Pad:</em> {{ topic.title }}</h2>

<!-- Server exec flag (read by JS to toggle the "server" option) -->
<div id="exec-flag" data-enabled="{{ 1 if ENABLE_SERVER_EXEC else 0 }}"></div>

<script>
  (function(){
    const flag = document.getElementById('exec-flag');
    const enabled = flag && flag.dataset.enabled === "1";
    const execModeSel = document.getElementById('exec-mode');
    if (!execModeSel) return;
    const serverOpt = [...execModeSel.options].find(o => o.value === 'server');
    if (enabled && serverOpt){ serverOpt.disabled = false; }
  })();
</script>

<div class="row" style="gap:8px; flex-wrap:wrap; align-items:center">
  <a class="buttonlike" href="{{ url_for('topic_view', project_id=project.id, page_id=page.id, topic_id=topic.id) }}">← Back to Topic</a>

  <form action="{{ url_for('codepad_cell_create', project_id=project.id, page_id=page.id, topic_id=topic.id) }}" method="post" style="margin:0">
    {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
    <button type="submit">+ Add Cell</button>
  </form>

  <a class="buttonlike" id="dl-link" href="{{ url_for('topic_code_download', project_id=project.id, page_id=page.id, topic_id=topic.id) }}">Download .py</a>
</div>

{% set server_enabled = ENABLE_SERVER_EXEC %}
<div id="exec-disabled-banner" class="banner{% if server_enabled %} hidden{% endif %}">
  Server execution is disabled. Ask an admin to set <code>EXEC_SERVER_ENABLED=true</code>.
</div>

<div class="card console-card">
  <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
    <label>Language:
      <select id="lang">
        <option value="python" selected>Python</option>
        <option value="cpp">C++ (server)</option>
      </select>
    </label>
    <label>Mode:
      <select id="exec-mode">
        <option value="browser" {% if not server_enabled %}selected{% endif %}>Browser (Pyodide)</option>
        <option value="server" {% if server_enabled %}selected{% endif %} {% if not server_enabled %}disabled{% endif %}>
          Server (venv){% if not server_enabled %} — disabled{% endif %}
        </option>
      </select>
    </label>
    <label>Scope:
      <select id="exec-scope">
        <option value="current">Current cell</option>
        <option value="all">All cells</option>
      </select>
    </label>
    <button id="run-btn">Run</button>
    <button id="stop-btn" disabled>Stop</button>
    <button id="clear-btn" type="button">Clear</button>
    <button id="copy-btn" type="button">Copy</button>
    <span id="status" class="muted" style="margin-left:auto;"></span>
  </div>
  <pre id="console" class="output" aria-live="polite">— output will appear here —</pre>
</div>

<div id="cells">
  {% for c in codecells %}
  <div class="card code-cell" id="cell-{{ c.id }}" data-cell-id="{{ c.id }}">
    <div class="row cell-toolbar">
      <strong>Cell #{{ loop.index }}</strong>
      <div class="row" style="gap:6px">
        <button type="button" onclick="setCurrent({{ c.id }})">Use as current</button>
        <button type="button" onclick="saveCell({{ c.id }})">Save</button>
        <form action="{{ url_for('codecell_delete', project_id=project.id, page_id=page.id, topic_id=topic.id, cell_id=c.id) }}"
              method="post" style="margin:0" onsubmit="return confirm('Delete this cell?')">
          {% if csrf_token is defined %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
          <button>Delete</button>
        </form>
      </div>
    </div>
    <textarea id="code-{{ c.id }}" class="codearea" spellcheck="false">{{ c.code }}</textarea>
  </div>
  {% endfor %}
</div>

<style>
  .buttonlike { background:#1f6feb; color:#fff; border:none; padding:8px 14px; border-radius:10px; text-decoration:none; display:inline-block; }
  .buttonlike:hover { opacity:.92; }
  .muted { opacity:.8 }
  .console-card { padding:12px; margin:12px 0; border:1px solid #22314a; background:#0b1220; border-radius:14px; }
  .output { min-height:220px; background:#050a16; color:#e6edf3; border:1px solid #22314a; border-radius:10px; padding:12px; white-space:pre-wrap; overflow:auto; }
  .code-cell { padding:10px; margin:12px 0; border:1px solid #22314a; background:#0b1220; border-radius:14px; }
  .cell-toolbar { justify-content:space-between; align-items:center; margin-bottom:8px; display:flex; }
  .banner{ padding:10px; border-radius:8px; background:#0b1220; border:1px solid #22314a; margin:10px 0; }
  .hidden{ display:none; }
  .CodeMirror { height:auto; min-height:160px; border:1px solid #22314a; border-radius:10px; background:#0b1020; color:#f5faff; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 14px; }
  .cm-s-darcula .CodeMirror-gutters { background:#0b1020; border-right:1px solid #22314a; }
  .cm-s-darcula .CodeMirror-cursor { border-left: 2px solid #7db7ff; }
  .cm-s-darcula .CodeMirror-selected { background:#173a63 !important; }
  .code-cell.active { outline:2px solid #1f6feb; border-radius:16px; }
</style>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/darcula.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/clike/clike.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/matchbrackets.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.js"></script>

<!-- Socket.IO (load if not already available) -->
<script>
if(!window.io){
  var s=document.createElement('script');
  s.src="https://cdn.socket.io/4.7.5/socket.io.min.js";
  s.crossOrigin="anonymous";
  document.head.appendChild(s);
}
</script>

<!-- Pyodide for browser Python -->
<script>
  let pyodideReady = (async ()=>{
    const { loadPyodide } = await import("https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.mjs");
    const py = await loadPyodide();
    try {
      py.setStdout({ batched: s => window.appendOut(s) });
      py.setStderr({ batched: s => window.appendOut(s) });
    } catch(e) {
      await py.runPythonAsync(`
import sys
class _W:
    def write(self,s):
        import js
        js.window.appendOut(s)
    def flush(self): pass
sys.stdout = _W()
sys.stderr = _W()
      `);
    }
    return py;
  })();
</script>

<!-- Safe CSRF exposure -->
{% if csrf_token is defined %}
<script>const CSRF = "{{ csrf_token() }}";</script>
{% else %}
<script>const CSRF = "";</script>
{% endif %}

<script>
// === Pyodide package loader ===
const PKG_MAP = { numpy: "numpy", pandas: "pandas", matplotlib: "matplotlib" };

function detectPackages(code){
  const needed = new Set();
  const re = /^\s*(?:from|import)\s+([a-zA-Z0-9_]+)/gm;
  let m; while ((m = re.exec(code)) !== null) { const lib = m[1]; if (PKG_MAP[lib]) needed.add(PKG_MAP[lib]); }
  return [...needed];
}

async function ensurePackages(code){
  const py = await pyodideReady;
  const pkgs = detectPackages(code);
  for (const p of pkgs){ await py.loadPackage(p); }
}

(function(){
  // Elements
  const consoleEl = document.getElementById('console');
  const statusEl  = document.getElementById('status');
  const runBtn    = document.getElementById('run-btn');
  const stopBtn   = document.getElementById('stop-btn');
  const clearBtn  = document.getElementById('clear-btn');
  const copyBtn   = document.getElementById('copy-btn');
  const execModeSel = document.getElementById('exec-mode');
  const execScopeSel= document.getElementById('exec-scope');
  const langSel     = document.getElementById('lang');
  const dlLink      = document.getElementById('dl-link');
  const banner      = document.getElementById('exec-disabled-banner');
  const SERVER_ENABLED = {{ 'true' if server_enabled else 'false' }};

  // Console helpers
  function appendOut(t){ consoleEl.textContent += t; consoleEl.scrollTop = consoleEl.scrollHeight; }
  window.appendOut = appendOut;
  function setStatus(t){ statusEl.textContent = t || ''; }
  function clearOut(){ consoleEl.textContent = ''; setStatus(''); }

  // CodeMirror editors
  const editors = new Map();
  function cmMode(){ return (langSel.value === 'cpp') ? 'text/x-c++src' : 'python'; }
  function initEditors(){
    document.querySelectorAll('textarea.codearea').forEach(ta=>{
      const id = parseInt(ta.id.replace('code-',''), 10);
      const cm = CodeMirror.fromTextArea(ta, {
        mode: cmMode(), theme: 'darcula', lineNumbers: true,
        indentUnit: 4, smartIndent: true, matchBrackets: true, autoCloseBrackets: true,
        viewportMargin: Infinity
      });
      editors.set(id, cm);
    });
  }
  function updateEditorsMode(){ const m = cmMode(); editors.forEach(cm=>cm.setOption('mode', m)); }
  function getCode(id){ const cm = editors.get(id); return cm ? cm.getValue() : ''; }
  function allCode(){ const parts=[]; editors.forEach(cm=>parts.push(cm.getValue())); return parts.join('\n\n'); }

  // Current cell selection
  let currentCellId = null;
  function setCurrent(id){
    currentCellId = id; setStatus('Current cell: #'+id);
    document.querySelectorAll('.code-cell').forEach(el=>el.classList.remove('active'));
    const el = document.querySelector(`#cell-${id}`); if (el) el.classList.add('active');
  }
  window.setCurrent = setCurrent;

  // Save cell
  window.saveCell = (id)=>{
    const code = getCode(id);
    fetch("{{ url_for('codecell_save', project_id=project.id, page_id=page.id, topic_id=topic.id, cell_id=0) }}".replace('0', id), {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded", ...(CSRF ? {'X-CSRFToken': CSRF} : {})},
      body:new URLSearchParams({code})
    }).then(r=>r.json()).then(_=>{ setStatus('Saved cell #'+id); }).catch(()=>setStatus('Save failed'));
  };

  // Download link reflects language
  function refreshDL(){
    const base = "{{ url_for('topic_code_download', project_id=project.id, page_id=page.id, topic_id=topic.id) }}";
    dlLink.textContent = (langSel.value === 'cpp') ? 'Download .cpp' : 'Download .py';
    dlLink.href = base + (langSel.value === 'cpp' ? '?lang=cpp' : '');
  }

  langSel.addEventListener('change', ()=>{
    updateEditorsMode(); refreshDL();
    if (langSel.value==='cpp' && execModeSel.value==='browser'){
      setStatus('C++ is not supported in-browser. Switch to Server mode.');
    } else { setStatus(''); }
  });

  execModeSel.addEventListener('change', ()=>{
    if (execModeSel.value === 'server' && !SERVER_ENABLED){
      execModeSel.value = 'browser';
      setStatus('Server execution is disabled.');
      banner && banner.classList.remove('hidden');
    }
    if (execModeSel.value === 'browser' && langSel.value === 'cpp'){
      setStatus('C++ requires Server mode.');
    }
  });

  // Socket (lazy)
  let sock = null;
  function ensureSocket(){
    if (sock || !window.io) return;
    sock = io({ transports: ["websocket"], upgrade: false });
    sock.emit("join_topic", {project_id: {{ project.id }}, page_id: {{ page.id }}, topic_id: {{ topic.id }}});
    sock.on("code_output", msg=>{
      if (msg.topic_id !== {{ topic.id }}) return;
      const text = String(msg.data || '');
      appendOut(`[${msg.stream}] ${text}${text.endsWith('\n')?'':'\n'}`);
    });
    sock.on("code_done", msg=>{
      if (msg.topic_id !== {{ topic.id }}) return;
      appendOut(`\n[status] process exited with code ${msg.returncode}\n`);
      setStatus('Finished');
      runBtn.disabled = false; stopBtn.disabled = true;
    });
  }

  // Run/Stop
  runBtn.onclick = async ()=>{
    clearOut(); runBtn.disabled = true; stopBtn.disabled = false;
    const mode = execModeSel.value, scope = execScopeSel.value, lang = langSel.value;
    const code = (scope === 'current') ? (currentCellId ? getCode(currentCellId) : '') : allCode();
    if (!code.trim()){ appendOut('No code to run.\n'); done(); return; }
    if (lang==='cpp' && mode==='browser'){ appendOut('[browser] C++ not supported in-browser.\n'); done(); return; }

    try{
      if (mode==='browser'){ await runBrowser(code); }
      else { await runServer(code, lang); ensureSocket(); }
    } finally { /* re-enabled by code_done or error */ }
  };

  stopBtn.onclick = ()=>{
    appendOut('[status] Stop requested (will terminate via server).\n');
    setStatus('Stop requested');
    if (sock){ sock.emit("code_stop", { project_id: {{ project.id }}, page_id: {{ page.id }}, topic_id: {{ topic.id }} }); }
  };

  clearBtn.onclick = clearOut;
  copyBtn.onclick  = async ()=>{ try{ await navigator.clipboard.writeText(consoleEl.textContent); setStatus('Copied'); } catch(e){ setStatus('Copy failed'); } };
  function done(){ runBtn.disabled = false; stopBtn.disabled = true; }

  async function runBrowser(code){
    try{
      const py = await pyodideReady;
      // NEW: auto-load packages used by the code (numpy/pandas/matplotlib)
      await ensurePackages(code);

      appendOut('[browser] Running in Pyodide…\n');
      const res = await py.runPythonAsync(code);
      if (typeof res !== 'undefined') appendOut(String(res)+'\n');
      setStatus('Done');
      done();
    }catch(e){ appendOut(String(e)+'\n'); setStatus('Error'); done(); }
  }

  async function runServer(code, lang){
    {% if not ENABLE_SERVER_EXEC %}
      appendOut('[server] Disabled. Ask owner to enable server execution.\n');
      setStatus('Disabled'); done(); return;
    {% else %}
      try{
        const r = await fetch("{{ url_for('topic_run', project_id=project.id, page_id=page.id, topic_id=topic.id) }}", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...(CSRF ? {'X-CSRFToken': CSRF} : {}) },
          body: JSON.stringify({ lang, code })
        });
        if (!r.ok){
          let msg = '';
          try { const j = await r.json(); msg = j.error || j.detail || ''; } catch { msg = await r.text(); }
          appendOut('Error: ' + (msg || r.statusText) + '\n');
          setStatus('Failed'); done(); return;
        }
        appendOut('Started. Streaming output…\n');
        setStatus('Running on server');
        // When complete, backend should emit "code_done" via socket (handled above)
      } catch (e){
        appendOut('Network error: ' + String(e) + '\n');
        setStatus('Failed'); done();
      }
    {% endif %}
  }

  // Init
  initEditors(); refreshDL();
  const first = document.querySelector('.code-cell'); if (first){ setCurrent(parseInt(first.dataset.cellId,10)); }
})();
</script>
{% endblock %}
